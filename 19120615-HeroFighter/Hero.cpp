#include "Hero.h"

// Hệ số thủ của đối phương bị giảm khi đối thủ bị khắc (conquered enemy def factor)
constexpr float CnqrdEnmyDEFFctr = 0.5;
// Hệ số công của hero đánh được tăng khi đối thủ bị khắc (conquered enemy my atk factor)
constexpr float CnqrdEnmyMyATKFctr = 1.1; 
// Hệ số thời gian ra đòn của hero bị khắc tăng (conquered by teammate speed factor)
constexpr float CnqrdByTmmtSPDFctr = 1.1;
// Hệ số máu được tăng của hero được tương sinh (generated by teammate hp factor)
constexpr float GnrtdByTmmtHPFctr = 1.15;

Hero::Hero(string name, float hp, float atk, float def, float spd)
{
	Name = name;
	HP = hp;
	ATK = atk;
	DEF = def;
	SPD = spd;
}

result_t Hero::Fight(Hero& enemy)
{
	/*
		- Ai có thời gian chờ = 0 được đánh trước.
		- Giả sử A đánh B.
		- A đánh B xong thì A phải chờ 1 khoảng thời gian. Do đó gán A.WAIT = A.SPD
		- Đồng thời giảm thời gian chờ của đối phương xuống 1 ms.
		- Giảm thời gian chờ trận đấu xuống 1 ms.
		- Tiếp tục lặp đến khi 1 trong 2 chết hoặc hết giờ.
	*/

	// Thực hiện đánh tới khi nào một trong 2 thua (máu <= 0)
	while (this->HP * enemy.HP > 0 && FightTime > 0) {
		// Ai có thời gian chờ = 0 được đánh trước
		// Bằng nhau thì pick random
		
		if (this->WAIT == 0 && enemy.WAIT == 0) {
			int r = rand() % 2 + 1;
			if (r == 1) {
				this->Attack(enemy);
			}
			else {
				enemy.Attack(*this);
			}
		}
		else if (this->WAIT == 0) {
			this->Attack(enemy);
		}
		else if (enemy.WAIT == 0) {
			enemy.Attack(*this);
		}

		FightTime--;
	}

	if (this->HP > 0 && enemy.HP > 0) {
		return FOUL;
	}
	else if (this->HP <= 0) {
		return LOST;
	}
	else {
		return VICTORY;
	}
}

void Hero::UpdtPntsForCnqrdOppnt(Hero& h1, Hero& h2)
{
	h2.DEF *= CnqrdEnmyDEFFctr;
	h1.ATK *= CnqrdEnmyMyATKFctr;
}

void Hero::UpdtPntsWhnCnqrdByTmmt()
{
	this->SPD *= CnqrdByTmmtSPDFctr;
}

void Hero::UpdtPntsWhnGnrtdByTmmt()
{
	this->HP *= GnrtdByTmmtHPFctr;
}

void Hero::Attack(Hero& enemy)
{
	enemy.HP -= (this->ATK - enemy.DEF);
	this->WAIT = this->SPD;

	if (enemy.WAIT > 0) {
		enemy.WAIT--;
	}
}